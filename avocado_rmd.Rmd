---
title: "Project 2"
author: "Nancie Kung, Calvin Raab, David Collier and Eitan Shimonovitz"
date: "5/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(PoEdata)
library(tseries)
library(forecast)
library(dynlm)
```

# Introduction 
In this project we will be analyzing Haas Avocados. 

- averageprice ~ date: how has the price of avocados changed over time?
- averageprice ~ region: how does average price vary with region?
- averageprice ~ volume: is average price influenced by total volume demanded?
- volume ~ season: how does volume vary with the seasons?
- volume ~ region: which regions like avocados the most?

# Description of the Data
Our project uses historical data on avocado prices and sales volume in U.S. markets between the years 2015 and 2018. This data is based on the weekly retail sales of Haas avocados reported by retailers' cash registers. It contains an aggregation of data from multiple locations across the United States and multiple types of retail outlets. The average price is the per unit cost for each avocado and the Product Lookup code indicates the total number sold for a given type of Haas avocado. The following variables are included in the data set:

• Date - the date of the observation
• AveragePrice - the average price of a single avocado
• Type - conventional or organic
• Year - the year
• Region - the city or region of the observation
• Total Volume - total number of avocados sold
• Hass.Small - total number of avocados with PLU 4046 sold (Small Hass Avocados)
• Hass.Large - total number of avocados with PLU 4225 sold (Large Hass Avocados)
• Hass.Extra.Large - total number of avocados with PLU 4770 sold (Extra Large Hass Avocados)

# Load Data
```{r}
avocados <- read.csv("avocado.csv")
attach(avocados)
avocados <- avocados %>%
  rename(
    Hass.Small = X4046,
    Hass.Large = X4225,
    Hass.Extra.Large = X4770
  )
```

### Creating TS V1
```{r}
#avocados <- read.csv("avocado.csv")
#attach(avocados)

#library(xts)
#library(ggplot2)
#avocados$Date <- as.Date(avocados$Date)

#avocados <- avocados %>% arrange(region, type, Date)

#avocados.ts1 <- xts(avocados, avocados$Date)

#avocados.ts2 <- ts(avocados, start=c(2015,1), end=c(2018,15), frequency=52)

#library(lubridate)
#avocados.ts3= ts(avocados$Date, 
#   freq=52, 
#   start=decimal_date(ymd("2015-01-04")))
```

### Creating A Time Series 
```{r}
library(dplyr)
avocados_us_conventional <- avocados %>% dplyr::filter(region == "TotalUS", type == "conventional")

avocados_us_conv.ts <- ts(avocados_us_conventional, frequency = 52, start = c(2015,1), end = c(2018,13))

avocados_us_organic <- avocados %>% dplyr::filter(region == "TotalUS", type == "organic")
avocados_us_org.ts <- ts(avocados_us_organic, frequency = 52, start = c(2015,1), end = c(2018,13))
```

# Exploratory Analysis 
### Average Price of Avocados Over Time
```{r}
plot(avocados_us_conv.ts[,3], ylab = "Avocado Price", xlab = "Date")
```


### Difference In Number of Avocados Sold Overtime for Different Size Haas Avocados 
```{r}
ts.plot(avocados_us_conv.ts[,5:7]/1000000, gpars=list(col=rainbow(4)),ylab = "Avocados Sold (Millions)", xlab = "Date", main = "Number of Avocados Sold")
legend(2015, 23, legend=c("S Avocados", "L Avocados", "XL Avocados"),
       col=c("red", "green", "cyan"), lty=1:2, cex=0.6)

```

### Difference In Number of Avocados Sold Over Time for Conventional vs Organic Avocados
```{r}
par(mfrow=c(2,2))
plot((avocados_us_conv.ts[,4] / 1000000), ylab = "Avocados Sold (Millions)", xlab = "Date", main = "Number of Conventional Avocados Sold", col = "brown")
plot((avocados_us_org.ts[,4] / 1000000), ylab = "Avocados Sold (Millions)", xlab = "Date", main = "Number of Organic Avocados Sold", col = "green")


```

Conventional avocados show strong seasonality, with spikes in the beginning of the year, while organic avocados show a consistent upwards trend from 2015 - 2018. Organic avocados appear to show their seasonality through severe dips at the end of the year, in the beginning of winter.

### Average Price By Region 
```{r}
avg_price_by_region <- aggregate(x = avocados$AveragePrice,
          by = list(avocados$region),
          FUN = mean)
#Top 10 Most Expensive Regions
slice(arrange(avg_price_by_region, desc(x)), 1:10)

#Top 10 Least Expensive Regions
slice(arrange(avg_price_by_region, x), 1:10)
```


# Data Analysis/Model

<<<<<<< HEAD
```{r}
y <- avocados_us_conv.ts[, "Total.Bags"]
ar_mod1 <- ar(y, aic = FALSE, order.max=2, method="ols")
summary(ar_mod1)
ar_mod1
forecast(ar_mod1, 52)
```

=======
### AR Process 
```{r}
library(tseries)
library(forecast)
library(dynlm)
AveragePrice.ts <- avocados_us_conv.ts[,3]
TotalVolume.ts <- avocados_us_conv.ts[,4]
tsdisplay(avocados_us_conv.ts[,3])
reg <- dynlm(AveragePrice.ts~L(AveragePrice.ts, 0:3))
reg <- dynlm(TotalVolume.ts~L(TotalVolume.ts, 0:3))

summary(reg)
library(corrplot)
M <- cor(avocados_us_conv.ts)
corrplot(M, method = "circle")
```
In order to see if this avocado data is cyclical, we will look at the ACF of both the Average Price and the Total Volume of our avocados. We set the lag to be maxed at 52, because there are 52 weeks in a year. From the ACF is can be seen that in the middle of the year there isn't much correlation, however near the end of the year we start to see significant statistical correlation. This tells us that there appears to be a cyclical, yearly relationship between our data. This means that data from 12 months ago can help predict the data of today. 
```{r}
tsdisplay(AveragePrice.ts, lag.max = 52)
tsdisplay(TotalVolume.ts, lag.max = 52)

```

The pattern of decreasing ACF with a single spike at lag = 1 for the PACF shows the pattern of an AR(1) process for average price. 

### Prediction with our AR model 
Here is an AR prediction model. We built a model to predict average price. The data we fed into our model was subsetted so we could use the final 5 results to test how accurate our model is. From the results below it can be seen that our prediction model did a good job and all of our confidence intervals created by the ar model held the actual prices. 
```{r}
avo.ar <- ar(AveragePrice.ts[1:164], aic = FALSE, order.max=4, method = "ols")
summary(avo.ar)
print(avo.ar) # Here you can see the two coefficients of the two lags 

plot(AveragePrice.ts)
lines(time(AveragePrice.ts)[1:164],AveragePrice.ts[1:164] - avo.ar$resid, col = "green")

plot(forecast(avo.ar, 5))

#forcast 2 steps-ahead 
forecast(avo.ar, 5)

#Compare to the actual next 5
AveragePrice.ts[165:169]
```


### Using Seasonality With AR(1) Model

The ACF and PACF for average price show clear seasonality year-over-year, which is to be expected with produce such as avocados. As such, we investigated including seasonality in our model to account for this effect, with AR(1) and MA(1) seasonality.
```{r}
seasonal_model <- Arima(AveragePrice.ts, order = c(1,0,0), seasonal = list(order=c(1,0,1), period = 52))

summary(seasonal_model)

plot(AveragePrice.ts)
lines(fitted(seasonal_model), col = "green")
```

We can see that the fitted values follow the data very closely. Next, we use the seasonal model to predict average price for the next year.

```{r}
plot(forecast(seasonal_model,52))
```

We see that the predicted price follows the seasonal trend of rising thoughout the year, then falling at the end of the year as we expect. This matches up with our knowledge of avocados being cheapest in the winter months and rising in price during the rest of the year. We also looked into forecasting with the built-in exponential smoothing capabilities of the forecast() function.

```{r}
plot(forecast(AveragePrice.ts, 52))

```

The exponentially smoothed prediction also follows the seasonal trend, but predicts that the trend of average price will actually decrease in the next year, which we do not believe to be likely. 


### Buidling an ARDL model 
Below is an ARDL(4,4) model. We built this model to see the statistical significance lags of both average price and total volume would have on predicting average price. We chose a lag of 4, for that represents one months worth of lags. The findings here are interesting in that lags of average price appeared to be less statistically significant than lags of volume. It appears as though lags of total volume are more statistically significant for predicting average price than lags of average price. 
```{r}
# ARDL(4,4)
avo.ardl <- dynlm(AveragePrice.ts ~ L(AveragePrice.ts,1:4) + L(TotalVolume.ts, 0:4))
summary(avo.ardl)
```

### Testing Instrumental Variables 
Using our subject mater expertise on avocados we thought to test total bags as an instrumental variable. The reason for this is we believed total bags to be a good indicator of total volume, but not necessarily of price. We created that IV test below. From our new model that takes into consideration total bags, it can be seen that there isn't much change in the significance of our parameters, suggesting that total bags is a weaker IV. 
```{r}
# This will only run if the second 
# Before testing total bags as an IV 
no.iv.mod <- lm(AveragePrice ~ Total.Volume + Hass.Small + Hass.Large + Hass.Extra.Large, data = avocados_us_conventional)
summary(no.iv.mod)

# Total Bags is the IV we are testing 
library(AER)
total.bags.iv <- ivreg(AveragePrice ~ Total.Volume + Hass.Small + Hass.Large + Hass.Extra.Large | Hass.Small + Hass.Large + Hass.Extra.Large + Total.Bags, data = avocados_us_conventional)
summary(total.bags.iv)
```





>>>>>>> 3769bb5caff3e9345948e8515e59872787002601
# Conclusions

# Future Work

# References
